/* Requires the Kubernetes Pipeline plugin */
pipeline {
    agent {
      kubernetes {
        yamlFile 'cicd/node-git-chromium-pod.yaml'
      }
    }
    stages {
        // stage('Test') {
        //   steps {
        //       sh 'yarn'
        //       sh 'yarn test:headless'
        //   }
        // }
        stage('Bump version') {
          steps {
              container('node-git-chromium') {
                withCredentials([sshUserPrivateKey(credentialsId: 'bitbucket-ssh-creds', keyFileVariable: 'SSH_KEY')]) {
                    sh """
                      git config --global --add safe.directory ${env.WORKSPACE}
                      git checkout main
                      npm version patch -m  "Upgrade to new version"
                    """
                }
              }
              withCredentials([sshUserPrivateKey(credentialsId: 'bitbucket-ssh-creds', keyFileVariable: 'SSH_KEY')]) {
                  sshagent(credentials: ['bitbucket-ssh-creds']) {
                      sh "git push"
                  }
              }
          }
        }
        stage('build') {
            steps {
                sh 'node --version'
                sh 'Building the app...'
                sh 'yarn build'
                writeFile file: 'test-results.txt', text: 'The build is finished executing'
            }
        }
    }

    post {
      success {
        archiveArtifacts 'test-results.txt'
      }
    }
}
