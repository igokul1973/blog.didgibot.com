/* Requires the Kubernetes Pipeline plugin */
pipeline {
    agent {
      kubernetes {
        yamlFile 'cicd/node-pod.yaml'
      }
    }
    stages {
        stage('Test') {
          steps {
            container('node') {
                sh 'yarn'
                sh 'yarn test:headless'
            }
          }
        }
        stage('Bump version') {
          steps {
            container('node') {
                sh 'npm version patch -m "Upgrade to %s commit"'
            }
          }
        }
        stage('Commit version') {
          agent {
            kubernetes {
              yamlFile 'cicd/git-pod.yaml'
            }
          }
          steps {
            container('git') {
                sh 'git add -all && git push'
            }
          }
        }
        stage('build') {
            steps {
                container('node') {
                  sh 'node --version'
                  sh 'Building the app...'
                  sh 'yarn build'
                  writeFile file: 'test-results.txt', text: 'The build is finished executing'
                }
            }
        }
    }
    post {
      success {
        archiveArtifacts 'test-results.txt'
      }
    }
}
